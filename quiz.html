<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Live Quiz | Olympiad Portal</title>
    <link rel="stylesheet" href="style (1).css">
    
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        /* Supplementary styles to bridge the layout gaps */
        .quiz-page-wrapper {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 30px;
            margin-top: 20px;
        }

        .question-palette {
            background: #1e293b;
            padding: 20px;
            border-radius: 18px;
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .grid div {
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            background: #334155;
            transition: 0.2s;
        }

        .question-text {
            font-size: 22px;
            line-height: 1.5;
            margin-bottom: 25px;
            color: #f8fafc;
        }

        /* Button Grouping */
        .action-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Responsive Fixes */
        @media (max-width: 900px) {
            .quiz-page-wrapper { grid-template-columns: 1fr; }
            .question-palette { position: static; }
        }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="nav-left">OLYMPIAD PORTAL</div>
    <div class="nav-right">
        <a href="dashboard.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="#" onclick="logoutUser()" style="color: #f87171;">Logout</a>
    </div>
</nav>

<div class="container">
    <div class="quiz-page-wrapper">
        
        <div class="quiz-main">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="subjectTitle" style="color: #ffb703; font-size: 18px;">SUBJECT LOADING...</h2>
                    <div class="timer">Time Left: <span id="timer">30:00</span></div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progressFill"></div>
                </div>
                <p style="font-size: 14px; color: #cbd5e1; margin-bottom: 10px;">
                    Question <span id="answeredCount">0</span> of <span id="totalCount">...</span>
                </p>

                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

                <h3 id="questionNumber" style="margin-bottom: 10px; color: #94a3b8;">Question 1</h3>
                <div id="questionText" class="question-text">Loading question content...</div>

                <div class="options" id="options">
                    </div>

                <div class="action-bar">
                    <button class="primary-btn" style="background: #334155; color: white;" onclick="prevQuestion()">Previous</button>
                    <div>
                        <button class="primary-btn" onclick="nextQuestion()" style="margin-right: 10px;">Save & Next</button>
                        <button class="primary-btn" style="background: #ef4444; color: white;" onclick="confirmSubmit()">Submit Quiz</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="question-palette">
            <h3 style="font-size: 16px; margin-bottom: 15px;">Question Map</h3>
            <div class="grid" id="questionGrid">
                </div>
            <div style="margin-top: 25px; font-size: 12px; color: #94a3b8;">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <div style="width: 12px; height: 12px; background: #28a745; border-radius: 3px; margin-right: 10px;"></div> Answered
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 3px; margin-right: 10px;"></div> Visited
                </div>
                <div style="display: flex; align-items: center;">
                    <div style="width: 12px; height: 12px; background: #334155; border-radius: 3px; margin-right: 10px;"></div> Not Visited
                </div>
            </div>
        </div>

    </div>
</div>

<script src="questions.js"></script>
<script type="module">
    // --- FIREBASE IMPORT & CONFIG (Keeping your original logic) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB49W61ggHHJcAJ5WyYTmX13I8NofsggSY",
      authDomain: "olympiad-portal-d2a5e.firebaseapp.com",
      projectId: "olympiad-portal-d2a5e",
      storageBucket: "olympiad-portal-d2a5e.firebasestorage.app",
      messagingSenderId: "341855557503",
      appId: "1:341855557503:web:5cb0c3a9ee424a6db0ec4a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let current = 0;
    let score = 0;
    let questions = [];
    const selectedClass = localStorage.getItem("selectedClass") || "class4";
    const selectedSubject = localStorage.getItem("selectedSubject") || "maths";
    let selectedAnswers = [];
    let visitedQuestions = [];

    document.getElementById("subjectTitle").innerText = `${selectedClass.toUpperCase()} : ${selectedSubject.toUpperCase()}`;

    // --- LOGOUT FUNCTION ---
    window.logoutUser = function() {
        if(confirm("Are you sure? Progress will be lost.")) {
            signOut(auth).then(() => window.location.replace("login.html"));
        }
    }

    // --- LOAD QUESTIONS ---
    async function loadQuestionsHybrid() {
        try {
            const q = query(collection(db, "questions"), where("class", "==", selectedClass), where("subject", "==", selectedSubject));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                questions = snapshot.docs.map(doc => doc.data()).sort(() => Math.random() - 0.5).slice(0, 30);
            } else {
                questions = questionsData[selectedClass][selectedSubject].sort(() => Math.random() - 0.5).slice(0, 30);
            }
        } catch (e) {
            questions = questionsData[selectedClass][selectedSubject].sort(() => Math.random() - 0.5).slice(0, 30);
        }
        selectedAnswers = new Array(questions.length).fill(null);
        visitedQuestions = new Array(questions.length).fill(false);
        document.getElementById("totalCount").innerText = questions.length;
        generateGrid();
        loadQuestion();
    }

    onAuthStateChanged(auth, (user) => { if(!user) window.location.replace("login.html"); else loadQuestionsHybrid(); });

    // --- TIMER ---
    let totalTime = 1800;
    const timerInterval = setInterval(() => {
        let min = Math.floor(totalTime/60);
        let sec = totalTime % 60;
        document.getElementById("timer").innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
        if(totalTime-- <= 0) { clearInterval(timerInterval); submitQuiz(); }
    }, 1000);

    // --- QUIZ LOGIC ---
    window.loadQuestion = function() {
        visitedQuestions[current] = true;
        const q = questions[current];
        document.getElementById("questionNumber").innerText = `Question ${current + 1}`;
        document.getElementById("questionText").innerHTML = q.q;
        
        let html = "";
        q.o.forEach((opt, i) => {
            html += `
            <label>
                <span>${opt}</span>
                <input type="radio" name="option" value="${i}" ${selectedAnswers[current] === i ? "checked" : ""} onchange="saveAnswer(${i})">
            </label>`;
        });
        document.getElementById("options").innerHTML = html;
        updateGrid();
        updateProgress();
    }

    window.saveAnswer = (v) => { selectedAnswers[current] = v; updateProgress(); updateGrid(); };
    window.nextQuestion = () => { if(current < questions.length-1) { current++; loadQuestion(); } };
    window.prevQuestion = () => { if(current > 0) { current--; loadQuestion(); } };
    window.jumpTo = (i) => { current = i; loadQuestion(); };

    window.confirmSubmit = () => { if(confirm("Submit your answers?")) submitQuiz(); };

    function submitQuiz() {
        score = selectedAnswers.reduce((acc, ans, i) => (ans === questions[i].a ? acc + 1 : acc), 0);
        const resultData = { score, total: questions.length, subject: selectedSubject, class: selectedClass, date: new Date().toLocaleString() };
        localStorage.setItem("quizResult", JSON.stringify(resultData));
        window.location.href = "result.html";
    }

    function generateGrid() {
        let html = "";
        for(let i=0; i<questions.length; i++) html += `<div onclick="jumpTo(${i})" id="q${i}">${i+1}</div>`;
        document.getElementById("questionGrid").innerHTML = html;
    }

    function updateProgress() {
        let answered = selectedAnswers.filter(a => a !== null).length;
        document.getElementById("answeredCount").innerText = answered;
        document.getElementById("progressFill").style.width = (answered / questions.length * 100) + "%";
    }

    function updateGrid() {
        for(let i=0; i<questions.length; i++){
            let cell = document.getElementById("q"+i);
            if(!cell) continue;
            cell.style.border = (i === current) ? "2px solid #ffb703" : "none";
            if(selectedAnswers[i] !== null) { cell.style.background = "#28a745"; cell.style.color = "white"; }
            else if(visitedQuestions[i]) { cell.style.background = "#dc3545"; cell.style.color = "white"; }
            else { cell.style.background = "#334155"; }
        }
    }
</script>
</body>
</html>
