<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Quiz - Olympiad Portal</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .quiz-wrapper { display: grid; grid-template-columns: 1fr 320px; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; height: calc(100vh - 100px); }
        .main-quiz-area { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); padding: 40px; overflow-y: auto; }
        .side-palette { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .option-label { display: flex; align-items: center; padding: 16px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { border-color: var(--primary); background: #1e293b; }
        .option-label input { margin-right: 15px; accent-color: var(--primary); width: 18px; height: 18px; }
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; }
        .grid-cell { padding: 10px 0; text-align: center; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .grid-cell.current { border-color: var(--primary); background: rgba(245, 158, 11, 0.2); color: var(--primary); font-weight: bold; }
        .grid-cell.answered { background: var(--success); color: black; border: none; font-weight: bold; }
        .grid-cell.visited { border-color: var(--danger); }
        #timerWrap { color: var(--primary); font-weight: 800; font-size: 1.2rem; }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="nav-logo" id="subjectTitle">Olympiad Portal</div>
    <div id="timerWrap">Time Left: <span id="timer">30:00</span></div>
</nav>

<div class="quiz-wrapper">
    <main class="main-quiz-area">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <span id="questionNumber" style="color: var(--text-muted); font-weight: 600;">Question</span>
            <div style="height: 6px; width: 200px; background: var(--bg-dark); border-radius: 10px; overflow: hidden;">
                <div id="progressFill" style="height: 100%; width: 0%; background: var(--primary); transition: 0.3s;"></div>
            </div>
        </div>
        <h2 id="questionText" style="line-height: 1.5; margin-bottom: 30px;">Loading...</h2>
        <div id="options" class="options"></div>
        <div style="margin-top: 40px; display: flex; gap: 15px;">
            <button class="btn-gold" style="background: var(--bg-dark); border: 1px solid var(--border); color: white;" onclick="prevQuestion()">Previous</button>
            <button class="btn-gold" onclick="nextQuestion()">Next</button>
            <button class="btn-gold" style="margin-left: auto; background: var(--danger); color: white;" onclick="confirmSubmit()">Submit Quiz</button>
        </div>
    </main>
    <aside class="side-palette">
        <h3>Question Palette</h3>
        <div class="grid-container" id="questionGrid"></div>
    </aside>
</div>

<script src="questions.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB49W61ggHHJcAJ5WyYTmX13I8NofsggSY",
      authDomain: "olympiad-portal-d2a5e.firebaseapp.com",
      projectId: "olympiad-portal-d2a5e",
      storageBucket: "olympiad-portal-d2a5e.firebasestorage.app",
      messagingSenderId: "341855557503",
      appId: "1:341855557503:web:5cb0c3a9ee424a6db0ec4a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let current = 0;
    let questions = [];
    let selectedAnswers = [];
    let visitedQuestions = [];
    const selectedClass = localStorage.getItem("selectedClass") || "class4";
    const selectedSubject = localStorage.getItem("selectedSubject") || "maths";

    document.getElementById("subjectTitle").textContent = `${selectedClass.toUpperCase()} â€¢ ${selectedSubject.toUpperCase()}`;

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.replace("login.html"); return; }
        await loadQuestionsHybrid();
    });

    async function loadQuestionsHybrid() {
        try {
            const q = query(collection(db, "questions"), where("class", "==", selectedClass), where("subject", "==", selectedSubject));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                questions = snapshot.docs.map(doc => doc.data()).sort(() => Math.random() - 0.5).slice(0, 30);
            } else {
                questions = questionsData[selectedClass][selectedSubject].sort(() => Math.random() - 0.5);
            }
        } catch (e) {
            questions = questionsData[selectedClass][selectedSubject].sort(() => Math.random() - 0.5);
        }
        selectedAnswers = new Array(questions.length).fill(null);
        visitedQuestions = new Array(questions.length).fill(false);
        generateGrid(); loadQuestion();
    }

    function loadQuestion() {
        visitedQuestions[current] = true;
        const q = questions[current];
        document.getElementById("questionNumber").innerText = `Question ${current + 1} of ${questions.length}`;
        document.getElementById("questionText").innerHTML = q.q;
        let html = '';
        q.o.forEach((opt, i) => {
            html += `<label class="option-label"><input type="radio" name="option" value="${i}" ${selectedAnswers[current] === i ? "checked" : ""} onchange="saveAnswer(${i})"><span>${opt}</span></label>`;
        });
        document.getElementById("options").innerHTML = html;
        updateGrid(); updateProgress();
    }

    window.saveAnswer = (v) => { selectedAnswers[current] = v; };
    window.nextQuestion = () => { if (current < questions.length - 1) { current++; loadQuestion(); } };
    window.prevQuestion = () => { if (current > 0) { current--; loadQuestion(); } };
    window.jumpTo = (i) => { current = i; loadQuestion(); };

    function generateGrid() {
        let html = '';
        for (let i = 0; i < questions.length; i++) html += `<div class="grid-cell" onclick="jumpTo(${i})" id="q${i}">${i + 1}</div>`;
        document.getElementById("questionGrid").innerHTML = html;
    }

    function updateGrid() {
        for (let i = 0; i < questions.length; i++) {
            const el = document.getElementById("q" + i);
            el.className = 'grid-cell';
            if (i === current) el.classList.add('current');
            else if (selectedAnswers[i] !== null) el.classList.add('answered');
            else if (visitedQuestions[i]) el.classList.add('visited');
        }
    }

    function updateProgress() {
        const answered = selectedAnswers.filter(a => a !== null).length;
        document.getElementById("progressFill").style.width = (answered / questions.length * 100) + "%";
    }

    let totalTime = 1800;
    const timer = setInterval(() => {
        const m = Math.floor(totalTime / 60); const s = totalTime % 60;
        document.getElementById("timer").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
        if (--totalTime < 0) { clearInterval(timer); submitQuiz(); }
    }, 1000);

    window.confirmSubmit = () => { if (confirm("Submit quiz?")) submitQuiz(); };
    function submitQuiz() {
        let score = 0;
        questions.forEach((q, i) => { if (selectedAnswers[i] === q.a) score++; });
        localStorage.setItem("quizResult", JSON.stringify({ score, total: questions.length, subject: selectedSubject, class: selectedClass, answers: selectedAnswers, questions }));
        window.location.href = "result.html";
    }
</script>
</body>
</html>
