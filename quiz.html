<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quiz</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="top-bar">
    <div id="subjectTitle"></div>
    <div>Time Left: <span id="timer">30:00</span></div>
</div>

<div class="quiz-container">

<div class="question-section">

    <div class="progress-wrapper">
        Answered: <span id="answeredCount">0</span>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <h3 id="questionNumber"></h3>
    <p id="questionText"></p>

    <div class="options" id="options"></div>

    <div class="quiz-buttons">
        <button onclick="prevQuestion()">Previous</button>
        <button onclick="nextQuestion()">Next</button>
        <button onclick="submitQuiz()">Submit</button>
    </div>

</div>

<div class="navigation-section">
    <h3>Question Palette</h3>
    <div class="grid" id="questionGrid"></div>
</div>

</div>

<script src="questions.js"></script>

<script>

let current = 0;
let score = 0;

const selectedClass = localStorage.getItem("selectedClass") || "class4";
const selectedSubject = localStorage.getItem("selectedSubject") || "maths";

document.getElementById("subjectTitle").innerText =
selectedClass.toUpperCase() + " - " + selectedSubject.toUpperCase();

/* ðŸ”¥ SAFE QUESTION LOAD */
if(typeof questionsData === "undefined"){
    alert("questions.js not loaded properly!");
}

const questions =
questionsData?.[selectedClass]?.[selectedSubject] || [];

if(questions.length === 0){
    alert("No questions found for selected class/subject.");
}

let selectedAnswers = new Array(questions.length).fill(null);

/* TIMER */
let totalTime = 1800;

setInterval(function(){
    let minutes = Math.floor(totalTime/60);
    let seconds = totalTime % 60;

    document.getElementById("timer").innerText =
    minutes + ":" + (seconds<10?"0":"") + seconds;

    totalTime--;

    if(totalTime < 0){
        submitQuiz();
    }

},1000);

/* LOAD QUESTION */
function loadQuestion(){

    if(!questions[current]) return;

    const q = questions[current];

    document.getElementById("questionNumber").innerText =
    "Question " + (current+1) + " of " + questions.length;

    document.getElementById("questionText").innerText = q.q;

    let optionsHTML = "";

    q.o.forEach((opt,i)=>{
        optionsHTML += `
        <label>
        <input type="radio" name="option" value="${i}"
        ${selectedAnswers[current]===i ? "checked":""}
        onchange="saveAnswer(${i})">
        ${opt}
        </label>`;
    });

    document.getElementById("options").innerHTML = optionsHTML;

    updateProgress();
}

/* SAVE ANSWER */
function saveAnswer(value){
    selectedAnswers[current] = value;
    updateProgress();
}

/* NAVIGATION */
function nextQuestion(){
    if(current < questions.length-1){
        current++;
        loadQuestion();
    }
}

function prevQuestion(){
    if(current > 0){
        current--;
        loadQuestion();
    }
}

/* PROGRESS */
function updateProgress(){
    let answered = selectedAnswers.filter(a => a !== null).length;
    document.getElementById("answeredCount").innerText = answered;

    let percentage = (answered / questions.length) * 100;
    document.getElementById("progressFill").style.width =
    percentage + "%";
}

/* SUBMIT */
function submitQuiz() {

    score = 0;

    for (let i = 0; i < questions.length; i++) {
        if (selectedAnswers[i] === questions[i].a) {
            score++;
        }
    }

    let resultData = {
        score: score,
        total: questions.length,
        subject: selectedSubject,
        class: selectedClass,
        answers: selectedAnswers,
        questions: questions,
        date: new Date().toLocaleString()
    };

    localStorage.setItem("quizResult", JSON.stringify(resultData));

    window.location.href = "result.html";
}

/* INITIAL LOAD */
if(questions.length > 0){
    loadQuestion();
}

</script>

</body>
</html>