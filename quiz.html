<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quiz</title>

<link rel="stylesheet" href="style.css">

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    background:#0f0f1b;
    color:white;
}

/* ===== NAVIGATION ===== */
nav{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 40px;
    background:#1e1e2f;
}

.nav-left{
    display:flex;
    align-items:center;
    gap:10px;
}

.nav-left img{
    width:35px;
    height:35px;
}

.nav-left h2{
    color:#ffb703;
    margin:0;
}

nav a{
    color:white;
    text-decoration:none;
    margin-left:25px;
    font-weight:500;
    cursor:pointer;
}

nav a:hover{
    color:#ffb703;
}

/* ===== TOP BAR ===== */
.top-bar{
    background:#141424;
    padding:15px 40px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:18px;
    border-bottom:1px solid rgba(255,255,255,0.08);
}
#timer{ color:#ffb703; font-weight:bold; }

/* ===== LAYOUT ===== */
.quiz-container{
    display:flex;
    height:calc(100vh - 120px);
}

.question-section{
    flex:3;
    padding:40px;
    overflow-y:auto;
}

.navigation-section{
    flex:1;
    background:#1a1a2e;
    padding:25px;
    border-left:1px solid rgba(255,255,255,0.08);
    overflow-y:auto;
}

/* ===== PROGRESS ===== */
.progress-wrapper{ margin-bottom:20px; }
.progress-bar{
    width:100%;
    height:12px;
    background:#333;
    border-radius:10px;
    overflow:hidden;
}
.progress-fill{
    height:100%;
    width:0%;
    background:#28a745;
    transition:width 0.3s ease;
}

/* OPTIONS */
.options label{
    display:block;
    padding:14px;
    margin:12px 0;
    font-size:17px;
    background:#1f1f35;
    border-radius:8px;
    cursor:pointer;
}
.options label:hover{
    background:#29294d;
}

/* BUTTONS */
.quiz-buttons{ margin-top:25px; }
.quiz-buttons button{
    width:130px;
    margin-right:10px;
    background:#ffb703;
    color:black;
    border:none;
    padding:10px;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
}
.quiz-buttons button:hover{
    background:#f59e0b;
}

/* GRID */
.grid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:10px;
    margin-top:20px;
}
.grid div{
    padding:10px;
    text-align:center;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    background:#333;
}
</style>
</head>

<body>

<!-- ===== NAVIGATION ===== -->
<nav>
    <div class="nav-left">
        <!-- Replace logo.png with your actual logo file -->
        <img src="logo.png" alt="Logo">
        <h2>Olympiad Portal</h2>
    </div>
    <div>
        <a onclick="confirmLeave('index.html')">Home</a>
        <a onclick="confirmLeave('dashboard.html')">Dashboard</a>
        <a onclick="confirmLeave('leaderboard.html')">Leaderboard</a>
        <a onclick="logout()">Logout</a>
    </div>
</nav>

<div class="top-bar">
    <div id="subjectTitle"></div>
    <div>Time Left: <span id="timer">30:00</span></div>
</div>

<div class="quiz-container">

<div class="question-section">
    <div class="progress-wrapper">
        Answered: <span id="answeredCount">0</span> /
        <span id="totalCount"></span>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <h3 id="questionNumber"></h3>
    <p id="questionText"></p>
    <div class="options" id="options"></div>

    <div class="quiz-buttons">
        <button onclick="prevQuestion()">Previous</button>
        <button onclick="nextQuestion()">Next</button>
        <button onclick="confirmSubmit()">Submit</button>
    </div>
</div>

<div class="navigation-section">
    <h3>Question Palette</h3>
    <div class="grid" id="questionGrid"></div>
</div>

</div>

<script src="questions.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB49W61ggHHJcAJ5WyYTmX13I8NofsggSY",
  authDomain: "olympiad-portal-d2a5e.firebaseapp.com",
  projectId: "olympiad-portal-d2a5e",
  storageBucket: "olympiad-portal-d2a5e.firebasestorage.app",
  messagingSenderId: "341855557503",
  appId: "1:341855557503:web:5cb0c3a9ee424a6db0ec4a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let current = 0;
let score = 0;
let questions = [];

const selectedClass = localStorage.getItem("selectedClass") || "class4";
const selectedSubject = localStorage.getItem("selectedSubject") || "maths";

document.getElementById("subjectTitle").innerText =
selectedClass.toUpperCase() + " - " + selectedSubject.toUpperCase();

let selectedAnswers = [];
let visitedQuestions = [];

/* LOAD QUESTIONS */
async function loadQuestionsHybrid() {
    try {
        const q = query(
            collection(db, "questions"),
            where("class", "==", selectedClass),
            where("subject", "==", selectedSubject)
        );
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
            let allQuestions = snapshot.docs.map(doc => doc.data());
            allQuestions.sort(() => Math.random() - 0.5);
            questions = allQuestions.slice(0, 30);
        } else {
            questions = questionsData[selectedClass][selectedSubject];
            questions.sort(() => Math.random() - 0.5);
        }
    } catch (error) {
        questions = questionsData[selectedClass][selectedSubject];
        questions.sort(() => Math.random() - 0.5);
    }

    selectedAnswers = new Array(questions.length).fill(null);
    visitedQuestions = new Array(questions.length).fill(false);

    document.getElementById("totalCount").innerText = questions.length;

    generateGrid();
    loadQuestion();
}

onAuthStateChanged(auth, async (user)=>{
    if(!user){
        window.location.replace("login.html");
        return;
    }
    await loadQuestionsHybrid();
});

/* ===== LEAVE WARNING ===== */
let quizSubmitted = false;

window.confirmLeave = function(url){
    if(!quizSubmitted){
        if(confirm("⚠️ Your quiz progress will be lost. Are you sure you want to leave?")){
            window.location.href = url;
        }
    } else {
        window.location.href = url;
    }
};

window.addEventListener("beforeunload", function (e) {
    if(!quizSubmitted){
        e.preventDefault();
        e.returnValue = "";
    }
});

/* ===== LOGOUT ===== */
window.logout = function(){
    if(confirm("⚠️ Are you sure you want to logout? Quiz progress will be lost.")){
        signOut(auth).then(()=>{
            localStorage.clear();
            sessionStorage.clear();
            window.location.replace("login.html");
        });
    }
};
</script>
</body>
</html>
