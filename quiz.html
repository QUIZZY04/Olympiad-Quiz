<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quiz</title>
<link rel="stylesheet" href="style.css">

<!-- ðŸ” Disable Cache -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
/* ===== TOP BAR ===== */
.top-bar{
    background:#111;
    padding:15px 30px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:18px;
    border-bottom:1px solid rgba(255,255,255,0.1);
}
#timer{ color:#ffb703; font-weight:bold; }

/* ===== LAYOUT ===== */
.quiz-container{ display:flex; height:calc(100vh - 60px); }
.question-section{ flex:3; padding:40px; overflow-y:auto; }
.navigation-section{ flex:1; background:rgba(255,255,255,0.05); padding:25px; border-left:1px solid rgba(255,255,255,0.1); overflow-y:auto; }

/* ===== PROGRESS BAR ===== */
.progress-wrapper{ margin-bottom:20px; }
.progress-bar{ width:100%; height:12px; background:#333; border-radius:10px; overflow:hidden; }
.progress-fill{ height:100%; width:0%; background:#28a745; transition:width 0.3s ease; }

/* OPTIONS */
.options label{
    display:block;
    padding:12px;
    margin:10px 0;
    font-size:18px;
    background:rgba(255,255,255,0.08);
    border-radius:8px;
    cursor:pointer;
    transition:0.2s;
}
.options label:hover{ background:rgba(255,183,3,0.15); }

.quiz-buttons{ margin-top:25px; }
.quiz-buttons button{
    width:130px;
    margin-right:10px;
    background:#ffb703;
    color:black;
    border:none;
    padding:10px;
    border-radius:6px;
    cursor:pointer;
}
.quiz-buttons button:hover{ background:#f59e0b; }

.grid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:10px;
    margin-top:20px;
}
.grid div{
    padding:10px;
    text-align:center;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    transition:0.2s;
}
</style>
</head>
<body>

<script>
window.addEventListener("pageshow", function (event) {
    if (event.persisted) {
        window.location.reload();
    }
});
</script>

<!-- ðŸ” Firebase Setup -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB49W61ggHHJcAJ5WyYTmX13I8NofsggSY",
  authDomain: "olympiad-portal-d2a5e.firebaseapp.com",
  projectId: "olympiad-portal-d2a5e",
  storageBucket: "olympiad-portal-d2a5e.appspot.com",  // âœ… corrected
  messagingSenderId: "341855557503",
  appId: "1:341855557503:web:5cb0c3a9ee424a6db0ec4a"
};

window.app = initializeApp(firebaseConfig);
window.auth = getAuth(window.app);
window.db = getFirestore(window.app);

onAuthStateChanged(window.auth, (user)=>{
    if(!user){
        window.location.replace("login.html");
    }
});

// ðŸ”‘ Save results to Firestore
window.saveResult = async function(userEmail, studentClass, subject, score, total) {
  try {
    await addDoc(collection(window.db, "leaderboard"), {
      email: userEmail,
      studentClass: studentClass,
      subject: subject,
      score: score,
      total: total,
      accuracy: Math.round((score / total) * 100),
      date: Timestamp.now()
    });
    console.log("Result saved to leaderboard!");
  } catch (error) {
    console.error("Error saving result:", error);
  }
}
</script>

<div class="top-bar">
    <div id="subjectTitle"></div>
    <div>Time Left: <span id="timer">30:00</span></div>
</div>

<div class="quiz-container">
<div class="question-section">
    <div class="progress-wrapper">
        Answered: <span id="answeredCount">0</span> / <span id="totalCount"></span>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    <h3 id="questionNumber"></h3>
    <p id="questionText"></p>
    <div class="options" id="options"></div>
    <div class="quiz-buttons">
        <button onclick="prevQuestion()">Previous</button>
        <button onclick="nextQuestion()">Next</button>
        <button onclick="confirmSubmit()">Submit</button>
    </div>
</div>
<div class="navigation-section">
    <h3>Question Palette</h3>
    <div class="grid" id="questionGrid"></div>
</div>
</div>

<script src="questions.js"></script>

<script>
/* ================= QUIZ LOGIC ================= */
let current = 0;
let score = 0;

const selectedClass = localStorage.getItem("selectedClass") || "class4";
const selectedSubject = localStorage.getItem("selectedSubject") || "maths";

document.getElementById("subjectTitle").innerText =
selectedClass.toUpperCase() + " - " + selectedSubject.toUpperCase();

const questions = questionsData[selectedClass][selectedSubject];
document.getElementById("totalCount").innerText = questions.length;

let selectedAnswers = new Array(questions.length).fill(null);
let visitedQuestions = new Array(questions.length).fill(false);

/* TIMER */
let totalTime = 1800;
const timerInterval = setInterval(function(){
    let minutes = Math.floor(totalTime/60);
    let seconds = totalTime % 60;
    document.getElementById("timer").innerText =
    minutes + ":" + (seconds<10?"0":"") + seconds;
    totalTime--;
    if(totalTime < 0){
        clearInterval(timerInterval);
        submitQuiz();
    }
},1000);

/* LOAD QUESTION */
function loadQuestion(){
    visitedQuestions[current] = true;
    const q = questions[current];
    document.getElementById("questionNumber").innerText =
    "Question " + (current+1) + " of " + questions.length;
    document.getElementById("questionText").innerHTML = q.q;
    let optionsHTML = "";
    q.o.forEach((opt,i)=>{
        optionsHTML += `
        <label>
        <input type="radio" name="option" value="${i}"
        ${selectedAnswers[current]===i ? "checked":""}
        onchange="saveAnswer(${i})">
        ${opt}
        </label>`;
    });
    document.getElementById("options").innerHTML = optionsHTML;
    updateGrid();
    updateProgress();
}

function saveAnswer(value){ selectedAnswers[current] = value; }
function nextQuestion(){ if(current < questions.length-1){ current++; loadQuestion(); } }
function prevQuestion(){ if(current > 0){ current--; loadQuestion(); } }

function updateProgress(){
    let answered = selectedAnswers.filter(a => a !== null).length;
    document.getElementById("answeredCount").innerText = answered;
    let percentage = (answered / questions.length) * 100;
    document.getElementById("progressFill").style.width = percentage + "%";
}

function confirmSubmit(){
    let answered = selectedAnswers.filter(a => a !== null).length;
    let confirmBox = confirm(
        "You have answered " + answered +
        " out of " + questions.length +
        " questions.\n\nAre you sure you want to submit?"
    );
    if(confirmBox){ submitQuiz(); }
}

function submitQuiz() {
    score = 0;
    for (let i = 0; i < questions.length; i++) {
        if (selectedAnswers[i] === questions[i].a) { score++; }
    }

    let resultData = {
        score: score,
        total: questions.length,
        subject: selectedSubject,
        class: selectedClass,
        answers: selectedAnswers,
        questions: questions,
        date: new Date().toLocaleString()
    };

    localStorage.setItem("quizResult", JSON.stringify(resultData));

    //
