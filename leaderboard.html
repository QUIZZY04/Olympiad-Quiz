<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB49W61ggHHJcAJ5WyYTmX13I8NofsggSY",
  authDomain: "olympiad-portal-d2a5e.firebaseapp.com",
  projectId: "olympiad-portal-d2a5e",
  storageBucket: "olympiad-portal-d2a5e.firebasestorage.app",
  messagingSenderId: "341855557503",
  appId: "1:341855557503:web:5cb0c3a9ee424a6db0ec4a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* LOGIN PROTECTION */
onAuthStateChanged(auth, (user)=>{
    if(!user){
        window.location.replace("login.html");
    } else {
        loadLeaderboard();
    }
});

/* LOAD LEADERBOARD */
async function loadLeaderboard() {

    const leaderboardBody = document.getElementById("leaderboardBody");
    leaderboardBody.innerHTML = "";

    try {

        const q = query(
            collection(db, "leaderboard"),
            orderBy("score", "desc")
        );

        const snapshot = await getDocs(q);

        if(snapshot.empty){
            leaderboardBody.innerHTML =
            `<tr><td colspan="7">No leaderboard data available</td></tr>`;
            return;
        }

        let rank = 1;

        snapshot.forEach(doc => {

            const data = doc.data();

            let rowClass = "";
            if(rank === 1) rowClass = "rank-1";
            if(rank === 2) rowClass = "rank-2";
            if(rank === 3) rowClass = "rank-3";

            let formattedDate = "";

            if(data.date){
                if(data.date.seconds){
                    formattedDate = new Date(data.date.seconds * 1000).toLocaleDateString();
                } else {
                    formattedDate = new Date(data.date).toLocaleDateString();
                }
            }

            leaderboardBody.innerHTML += `
            <tr class="${rowClass}">
                <td>${rank}</td>
                <td>${data.email || ""}</td>
                <td>${data.class || ""}</td>
                <td>${data.subject || ""}</td>
                <td>${data.score}/${data.total}</td>
                <td>${data.accuracy}%</td>
                <td>${formattedDate}</td>
            </tr>
            `;

            rank++;
        });

    } catch (error) {
        console.error("Leaderboard error:", error);
        leaderboardBody.innerHTML =
        `<tr><td colspan="7">Error loading leaderboard data</td></tr>`;
    }
}

/* LOGOUT */
window.logout = function(){
    signOut(auth).then(()=>{
        window.location.replace("login.html");
    });
};

</script>
